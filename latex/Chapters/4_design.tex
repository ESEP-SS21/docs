\chapter{Design}\label{ch:design}

%% Anmerkung: Die Implementierung MUSS zu Ihrem Design-Modell konsistent sein.
%% Strukturen, Verhalten und Bezeichner im Code müssen mit dem Modell übereinstimmen.
%% Daher ist ein wohlüberlegtes Design wichtig.


\section{Systemarchitektur}\label{sec:systemarchitektur}

%% Erstellen Sie eine Architektur für Ihre Software.
%% Geben Sie eine kurze Beschreibung Ihrer Architektur mit den dazugehörenden Komponenten
%% und Schnittstellen an.
%% Dokumentieren Sie hier wichtige technische Entscheidungen.
%% Welche Pattern werden gegebenenfalls verwendet? Wie erfolgt die interne Kommunikation?

In Abbildung~\ref{fig:cmp} ist die Systemarchitektur mithilfe eines UML Komponentendiagramms
visualisiert.

\begin{figure}[h]
    \centering
    \makebox[\textwidth][c]{\includegraphics[width=1.2\textwidth]{../out/diagrams/stage1/cmp}}
    \caption{Komponentendiagramm}
    \label{fig:cmp}
\end{figure}

\section{Komponentendesign}\label{sec:komponentendesign}

\subsection{hal\_actuators}\label{subsec:hal_actuators}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage2/cd_hal}}
    \caption{Klassendiagramm der HAL Aktorik}
    \label{fig:cd-hal}
\end{figure}

Die Aktorik-Hal enthält Abstraktionen für die Ansteuerung der Aktorik-Hardware.
Die Low-Level Hardwarezugriffe auf einzelne GPIO\-Register werden von der GPIOWrapper-Klasse gekapselt.
Sie erlaubt es gezielt die Funktionalität einzelner Pins der GPIO-Banks des BeagleBoneBlacks zu
Konfigurieren sowie einzelne Pins anzusteuern und auszulesen. Die einzelen Aktoren sind in Klassen unterteilt, 
welche Funktionalität zum Ansprechen von diesen bereitstellen. 
Das SortingMechanism-Interface stellt Methoden zum Versetzen in Auswerfe- und Durchlassposition, 
sowie zum Zurücksetzten in Ruhelage bereit. Die HAL-Klasse entscheidet bei der Erzeugung mittels 
eines Reads auf den WeicheOffen Sensor-Pin des GPIOs welche konkrete Ausprägung des SortingMechanism erzeugt wird
(1 Ejector, 0 Switch).
Die CBMotor-Klasse enthält Methoden zum Setzen des Bewegungszustandes. Das Enum Direction gibt dafür mögliche Werte an.
Die LEDs-Klasse erlaubt Zugriff auf die LEDs am Bedienpanel. Über das Enum LED\_Type kann die gewünschte LED ausgewählt werden.
Die Ansteuerung der Ampel wird von der Stoplight-Klasse übernommen Sie erlaubt es, einzelne Farben der Ampel anzusteuern.
Der Blink-Worker erlaubt es als aktive Komponente die Ampel in einer gewünschten Farbe blinken zu lassen.
Zusätzlich dazu gibt es noch eine HalManagerAct Klasse, die als Schnittstelle zum Dispatcher eingehende Events auf Methodenaufrüfe der Aktorik-Hal 
mappt und aus Übersichtlichkeitsgründen in diesem Diagramm weggelassen wurde.

\subsection{hal\_sensors}\label{subsec:hal_sensors}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/cd_hal_sens}}
    \caption{Klassendiagramm der HAL Sensorik}
    \label{fig:cd-hal-sens}
\end{figure}

Die Sensorik\-Hal enthält Abstraktionen für das Auslesen der Sensorik. 
Für den Low-Level Zugriff nutzt sie dieselbe GPIO-Abstraktion wie die Aktorik\-Hal.
Alle Sensorabstraktionen außer der HeightSensor stellen Methoden bereit, die Zustandsveränderungen 
seit dem letzten Auslesen erkennen. 
Lichtschranken werden über die LightBarriers-Klasse ausgelesen. 
Die Wahl der gewünschten Lichtschranke erfolgt über das LBType Enum.
Die Knöpfe des Bedienfelds lassen sich über die Klasse CPButtons abfragen. 
Der gewünschte Knopf kann über das Enum CPButtonType ausgewählt werden.
Metallsensor und EStop-Schalter können über die MetalSensor bzw. EStop Klasse ausgelesen werden.
Eine in diesem Diagramm aus Übersichtlichkeitsgründen weggelassene HalManagerSen-Klasse wartet
auf Interrupts vom GPIO, fragt dann alle Sensoren ab und sendet bei Veränderung das entsprechende 
Event an den Dispatcher. 
Der Höhensensor wird etwas anders verwaltet. Eine Messung lässt sich über sample() anfordern. 
Nach erfolgreicher Messung tritt ein Interrupt auf, welcher dem HalManagerSen mitteilt,
dass ein neuer Wert über get\_value abgefragt werden kann.
Zu Kalibrierungszwecken kann ein neuer Nullwert mit set\_zero\_point() gesetzt werden.

\subsection{dispatcher}\label{subsec:dispatcher}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/cd_dispatcher}}
    \caption{Klassendiagramm Dispatcher}
    \label{fig:cd-dispatcher}
\end{figure}

\section{Datenmodellierung}\label{sec:datenmodellierung}

%% Bestimmen Sie das Datenmodell und dokumentieren Sie es hier mit Hilfe von UML Klassendiagrammen
%% unter Beachtung der Designprinzipien. Die Modelle können mit Hilfe eines UML-Tools erstellt werden.
%% Hier ist dann ein Übersichtsbild einzufügen.
%% Geben Sie eine kurze textuelle Beschreibung des Datenmodells
%% und deren wichtigsten Klassen und Methoden an.


\FloatBarrier
\section{Verhaltensmodellierung}\label{sec:verhaltensmodellierung}

\subsection{Beschreibung des Servicemode}\label{subsec:beschreibung-des-servicemode}
Die detaillierte Durchführung des Servicemode ist in untenstehende Schritte unterteilt.
Dabei ist mit der Quittierung durch den Benutzer das Drücken des \gls{t_reset}s am \gls{ctrlp} gemeint.
Sobald die Anlage einen Test als erfolgreich eingestuft hat, wird die LED am \gls{t_reset} aktiviert.
Diese wird deaktiviert, sobald quittiert wurde.
Alle nachfolgenden Tests sind an beiden \glspl{anlage} durchzuführen.
\begin{enumerate}
    \item Der \gls{lb_he} wird kalibriert
    \item Testen der Sensoren
    \begin{enumerate}
        \item Die folgenden Lichtschranken werden überprüft.
        Dafür legt der Benutzer jeweils ein beliebiges \gls{workpiece} in die zu testende Lichtschranke und
        quittiert anschließend.
        \begin{itemize}
            \item \gls{lb_st}
            \item \gls{lb_en}
            \item \gls{lb_sw}
            \item \gls{lb_ra}
        \end{itemize}

        \item \Gls{me_sensor}
        \begin{itemize}
            \item Benutzer legt \gls{workpiece_metall} unter den \gls{me_sensor}
            \item Benutzer quittiert
        \end{itemize}
    \end{enumerate}

    \item Testen der Aktoren
    \begin{enumerate}
        \item LED's am \gls{ctrlp}
        \begin{itemize}
            \item LED am \gls{t_start}, \gls{t_reset} blinken dreimal
            \item Benutzer quittiert Funktion der LEDs
        \end{itemize}
        \item \Gls{ampel}
        \begin{itemize}
            \item Die folgenden \glspl{ampelled} blinken nacheinander schnell.
            \begin{itemize}
                \item 3x rot
                \item 3x gelb
                \item 3x grün
            \end{itemize}
            \item Benutzer quittiert Funktion der \gls{ampel}
            \item Die grüne \Gls{ampelled} wird wieder auf schnell blinkend geschaltet.
        \end{itemize}
        \item \Gls{belt}
        \begin{itemize}
            \item Das \Gls{belt} führt die folgende Aktionen aus:
            \begin{itemize}
                \item fährt für eine Sekunde schnell vorwärts
                \item fährt für eine Sekunde schnell rückwärts
                \item stoppt
            \end{itemize}
            \item Benutzer quittiert korrekte Funktionsweise des \gls{belt}s
        \end{itemize}
        \item \Gls{sortierer}
        \begin{enumerate}
            \item \Gls{sortierer} ist \gls{weiche}
            \begin{itemize}
                \item \gls{weiche} wird für zwei Sekunden auf \gls{do_not_discard} gesetzt
                \item \gls{weiche} wird auf \gls{discard} gesetzt
                \item Benutzer quittiert korrekte Funktionsweise der \gls{weiche}
            \end{itemize}
            \item \gls{sortierer} ist \gls{ejector}
            \begin{itemize}
                \item \Gls{ejector} wird aktiviert
                \item Benutzer quittiert korrekte Funktionsweise des \gls{ejector}s
            \end{itemize}
        \end{enumerate}
    \end{enumerate}
    \item Der Servicemodus wird beendet.
\end{enumerate}
Nach den oben genannten Schritten befindet sich das System wieder im Ruhezustand.


\subsection{Statemachines}\label{subsec:stm}
In diesem Abschnitt werden die Statemachines aufgelistet.

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[height=0.93\textheight]{../out/diagrams/stage3/stm_top_level}}
    \caption{Der Einstiegspunkt einer \gls{anlage}.
    Verwaltet die Betriebszustände und Sub-State Machines}
    \label{fig:stm_top_level}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_error}}
    \caption{Umgang mit Fehlern und Anzeige derer mithilfe der \gls{ampel}}
    \label{fig:stm_error}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_werkstueck_annahme}}
    \caption{Die Annahme eines \glspl{workpiece}s am Anfang der \gls{anlage}}
    \label{fig:stm_werkstueck_annahme}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_hoehe_messen}}
    \caption{Messung der Höhe eines \glspl{workpiece}s}
    \label{fig:stm_hoehe_messen}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_werkstueck_sortieren}}
    \caption{Sortierung von \glspl{workpiece}n}
    \label{fig:stm_werkstueck_sortieren}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_werkstueck_transfer}}
    \caption{Transfer eines \glspl{workpiece}s an die nächste \gls{anlage}}
    \label{fig:stm_werkstueck_transfer}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[scale = 0.5]{../out/diagrams/stage3/stm_werkstueck_transfer_req_antworten}
    \caption{Antworten eines Transfer-Request der vorherigen \gls{anlage}.
    Ein Transfer-Request wird in stm Workpiece Transfer (Abbildung~\ref{fig:stm_werkstueck_transfer}) gesendet}
    \label{fig:stm_werkstueck_transfer_req_antworten}
\end{figure}


%% Ihre Software muss zur Bearbeitung der Aufgaben ein Verhalten aufweisen.
%% Überlegen Sie sich dieses Verhalten auf Basis der Anforderungen und modellieren
%% Sie das Verhalten unter Verwendung von Verhaltensdiagrammen aus den Vorlesungen.

