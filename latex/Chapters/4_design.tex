\chapter{Design}\label{ch:design}

%% Anmerkung: Die Implementierung MUSS zu Ihrem Design-Modell konsistent sein.
%% Strukturen, Verhalten und Bezeichner im Code müssen mit dem Modell übereinstimmen.
%% Daher ist ein wohlüberlegtes Design wichtig.


\section{Systemarchitektur}\label{sec:systemarchitektur}

%% Erstellen Sie eine Architektur für Ihre Software.
%% Geben Sie eine kurze Beschreibung Ihrer Architektur mit den dazugehörenden Komponenten
%% und Schnittstellen an.
%% Dokumentieren Sie hier wichtige technische Entscheidungen.
%% Welche Pattern werden gegebenenfalls verwendet? Wie erfolgt die interne Kommunikation?

In Abbildung~\ref{fig:cmp} ist die Systemarchitektur mithilfe eines UML Komponentendiagramms
visualisiert.

\begin{figure}[h]
    \centering
    \makebox[\textwidth][c]{\includegraphics[width=1.2\textwidth]{../out/diagrams/stage1/cmp}}
    \caption{Komponentendiagramm}
    \label{fig:cmp}
\end{figure}

Die Architektur der Software für eine \gls{anlage} ist in \ref{fig:cmp} abgebildet.

\subsection{dispatcher}\label{subsec:dispatcher}
Da das System auf größtenteils eventbasierte Kommunikation zwischen den einzelnen Komponenten setzt,
ist der dispatcher das Herzstück der Software. Der Dispatcher erlaubt es Clients bestimmte Events zu abbonieren
und Events für die Verteilung auf dem System an den Dispatcher zu schicken. Erhält der Dispatcher ein Event von einem 
Client wird dieses an alle Clients geschickt, die das Event abboniert haben. Schnittstelle zum durch den Dispatcher 
verwalteten Eventsystem stellt das DispatcherClient Interface bereit, welches die Möglichkeit bietet Events zu abbonieren,
zu Verschicken und auf erhaltene Events zu reagieren. Da die Übermittlung von Events asynchron über das Message Passing System
von QNX erfolgt, befindet sich im Dispatcher zusätzlich eine connection\_management Komponente, die das Message Passing System 
kapselt und verwaltet. Die Kommunikation zur anderen Anlage findet über das QNX-eigene Qnet Protokoll statt. 
Der Dispatcher erlaubt es beim Senden eines Events auszuwählen, ob dieses nur auf der eigenen Anlage empfangen werden soll,
oder auch an den Dispatcher der verbundenen anderen Anlage weitergeleitet werden soll.

\subsection{hal}\label{subsec:hal}
Die hal stellt die Schnittstelle der Software zu Sensorik und Aktorik der \gls{anlage} bereit. 
Sie besteht zum einen aus der sensors-Komponente, die bei Ereignissen an Sensoren, wie z.B. 
dem Drücken eines Tasters oder dem Unterbrechen einer Lichtschranke,
ein entsprechendes Event an den Dispatcher schickt.
Zum anderen besitzt die hal eine actuators-Komponente.
Diese hat Events zur Hardwareansteuerung abboniert und führt bei Erhalt eines solchen Events die entsprechende Aktion durch.

\subsection{embedded\_recorder}\label{subsec:embedded_recorder}
Der Embedded Recorder erlaubt es Sequenzen von Ereignissen aufzunehmen und abzuspeichern, sowie diese Aufzeichnungen abzuspielen.
Dafür hat er im Aufnahmemodus beim Dispatcher die Sensorikevents der hal abboniert. 
Erhaltene Events werden mit Zeitstempel in einer Datei abgelegt.
Im Abspielmodus werden die aufgenommenen Events zu den jeweiligen Zeitpunkten an den Dispatcher gesendet und so auf dem Softwaresystem verteilt.

\subsection{logic}\label{subsec:logic}
Diese Komponente enthält die Steuerungslogik für die Verhaltenssteuerung, Betriebszustandsverwaltung sowie Fehlerbehandlung des \gls{system}.
Die stm-Unterkomponente enthält die für die Anlagensteuerung zuständigen Zustandsautomaten. Die Zustandsautomaten interagieren über das 
UnitData-Interface mit dem datamodel, welches für die Verwaltung der Werkstücke, sowie die Speicherung von allen weiteren für den Betrieb der \gls{anlage} nötigen
Informationen wie z.B. über den aktuellen Betriebszustand verantwortlich ist. 

\subsection{clients}\label{subsec:clients}
Die Clients-Komponente stellt einen Adapter zwischen dispatcher und den Zustandsautomaten dar. 
Sie übersetzt vom Dispatcher eingehende Events in Methodenaufrufe im Kontext der Statemachines.
Ebenso stellt sie den Zustandsautomaten eine Möglichkeit bereit, Events an den Dispatcher zu schicken.
Zusätzlich enthält die Komponente noch kleinere Hilfsclients die.z.B. einen Heartbeat für die Erkennung
von Verbindungsabbrüchen zwischen den Anlagen erzeugen.

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage2/cd_hal}}
    \caption{Klassendiagramm der HAL Aktorik}
    \label{fig:cd-hal}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/cd_hal_sens}}
    \caption{Klassendiagramm der HAL Sensorik}
    \label{fig:cd-hal-sens}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/cd_dispatcher}}
    \caption{Klassendiagramm Dispatcher}
    \label{fig:cd-dispatcher}
\end{figure}


\section{Datenmodellierung}\label{sec:datenmodellierung}

%% Bestimmen Sie das Datenmodell und dokumentieren Sie es hier mit Hilfe von UML Klassendiagrammen
%% unter Beachtung der Designprinzipien. Die Modelle können mit Hilfe eines UML-Tools erstellt werden.
%% Hier ist dann ein Übersichtsbild einzufügen.
%% Geben Sie eine kurze textuelle Beschreibung des Datenmodells
%% und deren wichtigsten Klassen und Methoden an.


\FloatBarrier
\section{Verhaltensmodellierung}\label{sec:verhaltensmodellierung}

\subsection{Beschreibung des Servicemode}\label{subsec:beschreibung-des-servicemode}
Die detaillierte Durchführung des Servicemode ist in untenstehende Schritte unterteilt.
Dabei ist mit der Quittierung durch den Benutzer das Drücken des \gls{t_reset}s am \gls{ctrlp} gemeint.
Sobald die Anlage einen Test als erfolgreich eingestuft hat, wird die LED am \gls{t_reset} aktiviert.
Diese wird deaktiviert, sobald quittiert wurde.
Alle nachfolgenden Tests sind an beiden \glspl{anlage} durchzuführen.
\begin{enumerate}
    \item Der \gls{lb_he} wird kalibriert
    \item Testen der Sensoren
    \begin{enumerate}
        \item Die folgenden Lichtschranken werden überprüft.
        Dafür legt der Benutzer jeweils ein beliebiges \gls{workpiece} in die zu testende Lichtschranke und
        quittiert anschließend.
        \begin{itemize}
            \item \gls{lb_st}
            \item \gls{lb_en}
            \item \gls{lb_sw}
            \item \gls{lb_ra}
        \end{itemize}

        \item \Gls{me_sensor}
        \begin{itemize}
            \item Benutzer legt \gls{workpiece_metall} unter den \gls{me_sensor}
            \item Benutzer quittiert
        \end{itemize}
    \end{enumerate}

    \item Testen der Aktoren
    \begin{enumerate}
        \item LED's am \gls{ctrlp}
        \begin{itemize}
            \item LED am \gls{t_start}, \gls{t_reset} blinken dreimal
            \item Benutzer quittiert Funktion der LEDs
        \end{itemize}
        \item \Gls{ampel}
        \begin{itemize}
            \item Die folgenden \glspl{ampelled} blinken nacheinander schnell.
            \begin{itemize}
                \item 3x rot
                \item 3x gelb
                \item 3x grün
            \end{itemize}
            \item Benutzer quittiert Funktion der \gls{ampel}
            \item Die grüne \Gls{ampelled} wird wieder auf schnell blinkend geschaltet.
        \end{itemize}
        \item \Gls{belt}
        \begin{itemize}
            \item Das \Gls{belt} führt die folgende Aktionen aus:
            \begin{itemize}
                \item fährt für eine Sekunde schnell vorwärts
                \item fährt für eine Sekunde schnell rückwärts
                \item stoppt
            \end{itemize}
            \item Benutzer quittiert korrekte Funktionsweise des \gls{belt}s
        \end{itemize}
        \item \Gls{sortierer}
        \begin{enumerate}
            \item \Gls{sortierer} ist \gls{weiche}
            \begin{itemize}
                \item \gls{weiche} wird für zwei Sekunden auf \gls{do_not_discard} gesetzt
                \item \gls{weiche} wird auf \gls{discard} gesetzt
                \item Benutzer quittiert korrekte Funktionsweise der \gls{weiche}
            \end{itemize}
            \item \gls{sortierer} ist \gls{ejector}
            \begin{itemize}
                \item \Gls{ejector} wird aktiviert
                \item Benutzer quittiert korrekte Funktionsweise des \gls{ejector}s
            \end{itemize}
        \end{enumerate}
    \end{enumerate}
    \item Der Servicemodus wird beendet.
\end{enumerate}
Nach den oben genannten Schritten befindet sich das System wieder im Ruhezustand.


\subsection{Statemachines}\label{subsec:stm}
In diesem Abschnitt werden die Statemachines aufgelistet.

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[height=0.93\textheight]{../out/diagrams/stage3/stm_top_level}}
    \caption{Der Einstiegspunkt einer \gls{anlage}.
    Verwaltet die Betriebszustände und Sub-State Machines}
    \label{fig:stm_top_level}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_error}}
    \caption{Umgang mit Fehlern und Anzeige derer mithilfe der \gls{ampel}}
    \label{fig:stm_error}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_werkstueck_annahme}}
    \caption{Die Annahme eines \glspl{workpiece}s am Anfang der \gls{anlage}}
    \label{fig:stm_werkstueck_annahme}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_hoehe_messen}}
    \caption{Messung der Höhe eines \glspl{workpiece}s}
    \label{fig:stm_hoehe_messen}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_werkstueck_sortieren}}
    \caption{Sortierung von \glspl{workpiece}n}
    \label{fig:stm_werkstueck_sortieren}
\end{figure}

\begin{figure}
    \makebox[\textwidth][c]{\includegraphics[width=1.25\textwidth]{../out/diagrams/stage3/stm_werkstueck_transfer}}
    \caption{Transfer eines \glspl{workpiece}s an die nächste \gls{anlage}}
    \label{fig:stm_werkstueck_transfer}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[scale = 0.5]{../out/diagrams/stage3/stm_werkstueck_transfer_req_antworten}
    \caption{Antworten eines Transfer-Request der vorherigen \gls{anlage}.
    Ein Transfer-Request wird in stm Workpiece Transfer (Abbildung~\ref{fig:stm_werkstueck_transfer}) gesendet}
    \label{fig:stm_werkstueck_transfer_req_antworten}
\end{figure}


%% Ihre Software muss zur Bearbeitung der Aufgaben ein Verhalten aufweisen.
%% Überlegen Sie sich dieses Verhalten auf Basis der Anforderungen und modellieren
%% Sie das Verhalten unter Verwendung von Verhaltensdiagrammen aus den Vorlesungen.

